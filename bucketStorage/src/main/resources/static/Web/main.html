<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Stay in Cloud: Main Page</title>
        <link rel="stylesheet" href="styles.css">
    </head>
    <body>
        <img src="Stay-in-cloud.png" alt="Stay-in-Cloud Logo">
        <h1>Stay-in-Cloud: Media Page</h1>
        <br>
        <button onclick="window.location.href='home.html'">Back to Homepage</button>
        <br><br>
        <br>
        <button onclick="bucketInit()">Initialize Bucket</button>
        <br><br>
        <div class="media-upload-section">
            <h2>Upload Media</h2>
            <form id="uploadForm">
                <label for="mediaFile">Select media to upload:</label>
                <input type="file" id="mediaFile" name="mediaFile" 
                accept=".pdf,.jpg,.jpeg,.png,.mp3,.mp4,.doc,.docx,.odt,.xls,.xlsx,.db,.ppt,.pptx">
                <br><br>
                <button type="submit">Upload</button>
            </form>
            <div id="upload-status">
                <!-- Upload status messages will appear here -->
            </div>
        </div>
        <div id="retrieve-media">
            <div class="list-media-in-storage">
                <h2>Media in OS bucket</h2>
                <button onclick="loadMediaList()">Refresh List</button>
                <ul id="mediaList">
                    <!-- List of media files will be populated here -->
                </ul>
            </div>
            <div class="media-download-section">
                <h2>Download Media</h2>
                <form id="downloadForm">
                    <label for="mediaFileName">Select media file to download:</label>
                    <select id="mediaFileName" name="mediaFileName" required>
                        <option value="">Select a file</option>
                    </select>
                    <br><br>
                    <button type="button" onclick="downloadViaPAR()">Download via file's PAR</button>
                </form>
                <div id="download-status"></div>
                
            </div>
        </div>
        <script>
            // Initialize Bucket
            async function bucketInit() {
                try {
                    const res = await fetch("/api/bucketInit");
                    const data = await res.json();
                    console.log("Bucket initialized:", data);
                } catch (err) {
                    console.error("Error initializing bucket:", err);
                }
            }

            //Listing Available objects
            async function loadMediaList() {
                try {
                    const res = await fetch("/api/listmedia");
                    if (!res.ok) throw new Error("Failed to fetch file list");
                    const files = await res.json();

                    const list = document.getElementById("mediaList");
                    const dropdown = document.getElementById("mediaFileName");
                    
                    // Clear existing content
                    list.innerHTML = "";
                    // Clear dropdown options except the first one
                    while (dropdown.children.length > 1) {
                        dropdown.removeChild(dropdown.lastChild);
                    }
                    
                    files.forEach(file => {
                        // Populate unordered list
                        const li = document.createElement("li");
                        li.textContent = file;
                        list.appendChild(li);

                        // Populate dropdown for downloading
                        const option = document.createElement("option");
                        option.value = file;
                        option.textContent = file;
                        dropdown.appendChild(option);
                    });
                } catch (err) {
                    console.error("Error listing objects:", err);
                    const list = document.getElementById("mediaList");
                    list.innerHTML = "<li>Failed to load media list.</li>";
                }
            }
            
            // Download file using PAR
            async function downloadViaPAR() {
                const fileSelect = document.getElementById('mediaFileName');
                const fileName = fileSelect.value;
                const downloadStatus = document.getElementById('download-status');
                
                if (!fileName) {
                    downloadStatus.textContent = "Please select a file to download.";
                    return;
                }
                
                try {
                    // Create a file-specific PAR
                    const formData = new FormData();
                    formData.append('fileName', fileName);
                    
                    const response = await fetch('/api/createFilePAR', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const parUrl = await response.text();
                        
                        // Open the PAR URL in a new tab for download
                        const link = document.createElement('a');
                        link.href = parUrl;
                        link.target = '_blank';
                        link.download = fileName;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        downloadStatus.innerHTML = `
                            <div style="color: green;">
                                PAR download initiated! If download doesn't start automatically, 
                                <a href="${parUrl}" target="_blank">click here</a>
                            </div>
                        `;
                    } else {
                        throw new Error('Failed to create file PAR with status ' + response.status);
                    }
                } catch (error) {
                    downloadStatus.textContent = "PAR download failed: " + error.message;
                    console.error('PAR download error:', error);
                }
            }

            // Handling file uploads
            document.getElementById('uploadForm').addEventListener('submit', async function (event) {
                event.preventDefault();
                const fileInput = document.getElementById('mediaFile');
                const file = fileInput.files[0];
                const uploadStatus = document.getElementById('upload-status');
                
                if (!file) {
                    uploadStatus.textContent = "Please select a file to upload.";
                    return;
                }
            
                const formData = new FormData();
                formData.append('file', file);
            
                try {
                    // Corrected endpoint path to /api/upload
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
            
                    if (response.ok) {
                        const result = await response.text();
                        uploadStatus.textContent = "Upload successful! " + result;
                        loadMediaList();
                    } else {
                        throw new Error('Upload failed with status ' + response.status);
                    }
                } catch (error) {
                    uploadStatus.textContent = "Upload failed: " + error.message;
                    console.error('Upload error:', error);
                }
            });


            //list files before/after upload
            document.addEventListener("DOMContentLoaded", () => {
                bucketInit();
                loadMediaList();
            });
        
        </script>
    </body>
</html>